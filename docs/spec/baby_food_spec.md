# 離乳食記録機能 設計書

## 1. 概要

### 1.1 目的
離乳食の食材・量を記録し、赤ちゃんの食事履歴を管理できるようにする。食材ごとの摂取状況を把握し、アレルギー確認や栄養管理に役立てる。

### 1.2 機能概要
- 授乳表内に「離乳食」行を追加
- 時間軸のマス目タップで離乳食記録画面を表示
- 食材カテゴリから食材を選択
- 各食材の食べた量を記録（任意）
- 食材ごとに子供の反応を記録（good / normal / bad）
- ベビーの記録画面に「離乳食」タブを追加し、食材一覧をカテゴリ別に表示
- カスタム食材の追加

---

## 2. 画面仕様

### 2.1 授乳表への統合

授乳表の列に「離乳食」を追加する。

```
┌──────┬──────┬──────┬──────┬────────┬────┬────┬──────┬──────┐
│ 時間 │ 授乳 │ミルク│搾母乳│ 離乳食 │ 尿 │ 便 │ 体温 │その他│
│      │      │      │      │ ↑新規  │    │    │      │      │
├──────┼──────┼──────┼──────┼────────┼────┼────┼──────┼──────┤
│   7  │      │      │      │        │    │    │      │      │
├──────┼──────┼──────┼──────┼────────┼────┼────┼──────┼──────┤
│   8  │      │      │      │   ●    │    │    │      │      │
├──────┼──────┼──────┼──────┼────────┼────┼────┼──────┼──────┤
│   9  │      │      │      │        │    │    │      │      │
├──────┼──────┼──────┼──────┼────────┼────┼────┼──────┼──────┤
│  10  │      │      │      │        │    │    │ 37.2 │      │
├──────┼──────┼──────┼──────┼────────┼────┼────┼──────┼──────┤
│  11  │      │      │      │        │    │    │      │      │
├──────┼──────┼──────┼──────┼────────┼────┼────┼──────┼──────┤
│  12  │      │  50  │  50  │   ●    │    │    │      │      │
├──────┼──────┼──────┼──────┼────────┼────┼────┼──────┼──────┤
│  13  │      │      │      │        │    │    │      │      │
├──────┼──────┼──────┼──────┼────────┼────┼────┼──────┼──────┤
│  ... │      │      │      │        │    │    │      │      │
├──────┼──────┼──────┼──────┼────────┼────┼────┼──────┼──────┤
│ 合計 │ 2回  │140ml │ 50ml │  2回   │1回 │1回 │      │      │
└──────┴──────┴──────┴──────┴────────┴────┴────┴──────┴──────┘
```

#### 表示仕様
- 離乳食列には記録がある場合 ● を表示
- 合計行には離乳食の記録回数を表示

#### インタラクション
| アクション | 動作 |
|-----------|------|
| 空きマスをタップ | 離乳食記録画面（新規）を表示 |
| 記録済みマスをタップ | 離乳食記録画面（編集）を表示 |

---

### 2.2 食材選択画面

マス目タップ後に表示される画面。8つの食材カテゴリから食材を選択する。

```
┌─────────────────────────────────────────────────┐
│  ←  離乳食を記録           12:00               │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌───────────────┐  ┌───────────────┐          │
│  │  🍚           │  │  🐟           │          │
│  │ 米・パン・麺   │  │    魚        │          │
│  └───────────────┘  └───────────────┘          │
│                                                 │
│  ┌───────────────┐  ┌───────────────┐          │
│  │  🥩           │  │  🥬           │          │
│  │    肉        │  │   野菜        │          │
│  └───────────────┘  └───────────────┘          │
│                                                 │
│  ┌───────────────┐  ┌───────────────┐          │
│  │  🍎           │  │  🥛           │          │
│  │   果物        │  │  乳製品       │          │
│  └───────────────┘  └───────────────┘          │
│                                                 │
│  ┌───────────────┐  ┌───────────────┐          │
│  │  🫘           │  │  📦           │          │
│  │ 大豆製品      │  │  その他       │          │
│  └───────────────┘  └───────────────┘          │
│                                                 │
├─────────────────────────────────────────────────┤
│  選択中: にんじん, 豆腐, 米              [次へ] │
└─────────────────────────────────────────────────┘
```

#### カテゴリタップ後のプルダウン展開

カテゴリをタップすると、その場でアコーディオンが展開され、食材を選択できる。

```
┌─────────────────────────────────────────────────┐
│  ←  離乳食を記録           12:00               │
├─────────────────────────────────────────────────┤
│ 食材を選択        ?記録したい食材がない場合は   │
├─────────────────────────────────────────────────┤
│ 米・パン・麺                               ▲   │ ← 選択中はピンク背景
├─────────────────────────────────────────────────┤
│  ☑ 米    ☐ パン粥   ☑ うどん   ☐ そば        │
│  ☐ そうめん  ☐ マカロニ  ☐ スパゲッティ      │
│  ☐ 中華麺                                      │
├─────────────────────────────────────────────────┤
│ 魚                                         ▼   │
├─────────────────────────────────────────────────┤
│ 肉                                         ▼   │
├─────────────────────────────────────────────────┤
│  ...                                            │
│                                                 │
├─────────────────────────────────────────────────┤
│  選択中: 米, うどん                      [次へ] │
└─────────────────────────────────────────────────┘
```

#### ヘルプ表示

「?記録したい食材がない場合は」をタップするとヘルプダイアログを表示。

```
┌─────────────────────────────────────────────────┐
│  食材の追加について                             │
├─────────────────────────────────────────────────┤
│                                                 │
│  ベビーの記録画面の「離乳食」タブから           │
│  食材を追加してください。                       │
│                                                 │
│  追加した食材は、すべての記録で選択できる       │
│  ようになります。                               │
│                                                 │
│                              [閉じる]           │
└─────────────────────────────────────────────────┘
```

**備考**: カスタム食材の追加・編集・削除は離乳食タブから行う。

---

### 2.3 量の記録画面

食材選択後、「次へ」をタップすると遷移。選択した食材それぞれの量、子供の反応、アレルギー有無、メモを記録する。

```
┌─────────────────────────────────────────────────┐
│  ←  食べた量を記録                             │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 🍚 米                                    │   │
│  │ ─────────────────────────────────────── │   │
│  │ ┌─────────────┐  ┌─────────────────┐    │   │
│  │ │ 大さじ  ▼  │  │     5          │    │   │
│  │ └─────────────┘  └─────────────────┘    │   │
│  │ ─────────────────────────────────────── │   │
│  │ 反応 [😊] [😐] [😢]   アレルギー [☐]    │   │
│  │ ─────────────────────────────────────── │   │
│  │ メモ: ______________________________    │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 🍜 うどん                                │   │
│  │ ─────────────────────────────────────── │   │
│  │ ┌─────────────┐  ┌─────────────────┐    │   │
│  │ │ g       ▼  │  │                │    │   │
│  │ └─────────────┘  └─────────────────┘    │   │
│  │          ↑ 量は未入力でもOK              │   │
│  │ ─────────────────────────────────────── │   │
│  │ 反応 [😊] [😐] [😢]   アレルギー [☐]    │   │
│  │ ─────────────────────────────────────── │   │
│  │ メモ: ______________________________    │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
├─────────────────────────────────────────────────┤
│                              [保存]             │
└─────────────────────────────────────────────────┘
```

#### レイアウト仕様

各食材はカード形式で縦に配置し、以下の4行構成とする：

| 行 | 内容 |
|---|------|
| 1行目 | 食材名（アイコン付き） |
| 2行目 | 単位選択ドロップダウン + 数値入力フィールド |
| 3行目 | 子供の反応（3択アイコン） + アレルギーチェックボックス |
| 4行目 | メモ入力欄（1行テキストフィールド） |

#### 量の入力仕様

| 項目 | 仕様 |
|------|------|
| 量の入力 | 数値のフリー入力（小数可） |
| 単位選択 | `大さじ` / `小さじ` / `ml` / `g` の4択 |
| 入力必須 | いいえ（量未入力でも保存可能） |
| デフォルト単位 | `大さじ` |

#### 子供の反応の入力仕様

| 項目 | 仕様 |
|------|------|
| 反応の選択 | 子供のアイコンに応じた3択（good / normal / bad） |
| 表示アイコン | 例: 子供アイコンが `bear` の場合 `bear_good` / `bear_normal` / `bear_bad` |
| 入力必須 | いいえ（未選択でも保存可能） |

#### アレルギー有無の入力仕様

| 項目 | 仕様 |
|------|------|
| アレルギー有無 | チェックボックス |
| デフォルト | 未チェック（false） |
| 入力必須 | いいえ（未チェックでも保存可能） |
| 表示 | 「アレルギー」ラベル + チェックボックス |

#### メモの入力仕様

| 項目 | 仕様 |
|------|------|
| メモ入力 | 1行テキストフィールド（任意入力） |
| 最大文字数 | 100文字 |
| プレースホルダー | 「メモを入力」 |
| 入力必須 | いいえ（未入力でも保存可能） |

---

### 2.4 離乳食タブ（食材一覧画面）

ベビーの記録画面のタブ構成に「離乳食」タブを追加し、授乳表タブと成長曲線タブの間に配置する。
離乳食タブでは食材カテゴリごとのサブタブを表示し、各カテゴリで「食べたかどうか」「子供の反応」を確認できる。
データは `baby_food_records` を集計して表示する（案A）。

```
タブ構成: [授乳表] [離乳食] [成長曲線]
```

```
┌─────────────────────────────────────────────────┐
│  離乳食                                          │
├─────────────────────────────────────────────────┤
│  [米・パン・麺] [魚] [肉] [野菜] [果物] ...      │
├─────────────────────────────────────────────────┤
│  🍚 米            食べた      反応: bear_good    │
│  🍞 パン粥        未         反応: ー            │
│  🍜 うどん        食べた      反応: bear_normal  │
│  ...                                            │
├─────────────────────────────────────────────────┤
│  ─── 追加した食材 ───                           │
│  牛肉            食べた      反応: ー       ⋮   │
│  ラム肉          未         反応: ー        ⋮   │
├─────────────────────────────────────────────────┤
│  ＋ 食材を追加                                   │
└─────────────────────────────────────────────────┘
```

#### カスタム食材の管理

カスタム食材（ユーザーが追加した食材）は、デフォルト食材の下に「追加した食材」セクションとして表示される。
カスタム食材には3点リーダー（⋮）メニューがあり、編集・削除ができる。

```
┌─────────────────────────────────────────────────┐
│  牛肉            食べた      反応: ー       ⋮   │
│                                    ┌───────────┐│
│                                    │ 編集      ││
│                                    │ 削除      ││
│                                    └───────────┘│
└─────────────────────────────────────────────────┘
```

#### 機能仕様

| 機能 | 説明 |
|------|------|
| 食材追加 | 「＋ 食材を追加」をタップしてダイアログで追加 |
| 食材編集 | カスタム食材の3点リーダー → 「編集」で名前を変更 |
| 食材削除 | カスタム食材の3点リーダー → 「削除」で削除 |

**注意**: デフォルト食材の削除・非表示機能は廃止。

#### 食材追加ダイアログ

```
┌─────────────────────────────────────────────────┐
│  肉に食材を追加                                 │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 食材名を入力                            │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│         [キャンセル]        [追加]              │
└─────────────────────────────────────────────────┘
```

#### 食材編集ダイアログ

```
┌─────────────────────────────────────────────────┐
│  食材を編集                                     │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │ 牛肉                                    │   │
│  └─────────────────────────────────────────┘   │
│                                                 │
│         [キャンセル]        [保存]              │
└─────────────────────────────────────────────────┘
```

#### 削除確認ダイアログ

```
┌─────────────────────────────────────────────────┐
│  食材を削除                                     │
├─────────────────────────────────────────────────┤
│                                                 │
│  「牛肉」を削除しますか？                        │
│                                                 │
│  ※過去の記録からは削除されません。              │
│                                                 │
│         [キャンセル]        [削除]              │
└─────────────────────────────────────────────────┘
```

---

## 3. 食材カテゴリ・プリセット一覧

### 3.1 カテゴリ一覧

| カテゴリ | アイコン | プリセット食材 |
|---------|---------|---------------|
| 米・パン・麺 | 🍚 | 米, パン粥, うどん, そば, そうめん, マカロニ, スパゲッティ, 中華麺 |
| 魚 | 🐟 | タラ, タイ, しらす, カジキ, マグロ, ツナ, あじ, いわし, さば, さわら, さんま, ぶり, さけ, えび |
| 肉 | 🥩 | 鶏肉, 豚肉 |
| 野菜 | 🥬 | じゃがいも, さつまいも, さといも, やまいも, かぼちゃ, にんじん, 大根, かぶ, 玉ねぎ, 小松菜, ほうれん草, トマト, ブロッコリー, キャベツ, ピーマン, なす, きゅうり, いんげん, にら, ねぎ, 枝豆, とうもろこし, れんこん, オクラ, きのこ類 |
| 果物 | 🍎 | バナナ, りんご, みかん, ぶどう, いちご, 柿, 梨, すいか, メロン, もも |
| 乳製品 | 🥛 | ヨーグルト, 牛乳（調理用）, 牛乳（飲料用） |
| 大豆製品 | 🫘 | 豆腐, きな粉, 納豆, 豆乳, チーズ |
| その他 | 📦 | たまご, 海苔, わかめ, こんにゃく, ひじき, 春雨, ゼリー |

### 3.2 カスタム食材

- 各カテゴリにユーザーが独自の食材を追加可能
- カスタム食材は端末ローカル（またはFirestore）に保存
- 削除・編集も可能

---

## 4. データ構造

### 4.1 離乳食記録（BabyFoodRecord）

```
BabyFoodRecord
├── id: UUID
├── recordedAt: DateTime（記録日時）
├── childId: UUID（対象の子供）
├── items: List<BabyFoodItem>（食べた食材リスト）
├── createdAt: DateTime
└── updatedAt: DateTime
```

### 4.2 食材アイテム（BabyFoodItem）

```
BabyFoodItem
├── ingredientId: UUID（食材のID）
├── ingredientName: String（食材名）
├── categoryId: String（カテゴリID: grains, fish, meat, vegetables, fruits, dairy, soy, other）
├── amount: Double?（量、nullable）
├── unit: AmountUnit?（単位、nullable）
├── reaction: BabyFoodReaction?（子供の反応、nullable）
├── hasAllergy: bool?（アレルギー反応があったか、nullable）
└── memo: String?（メモ、nullable、最大100文字）
```

### 4.3 子供の反応（BabyFoodReaction）

```
enum BabyFoodReaction {
  good,
  normal,
  bad
}
```

### 4.4 量の単位（AmountUnit）

```
enum AmountUnit {
  tablespoon,  // 大さじ
  teaspoon,    // 小さじ
  ml,          // ml
  gram         // g
}
```

### 4.5 カスタム食材（CustomIngredient）

```
CustomIngredient
├── id: UUID
├── name: String（食材名）
├── categoryId: String（所属カテゴリID）
├── createdAt: DateTime
└── householdId: UUID（世帯ごとに管理）
```

---

## 5. Firestore構造

### 5.1 離乳食記録

```
households/{householdId}/children/{childId}/baby_food_records/{recordId}
├── recorded_at: Timestamp
├── items: [
│   {
│     ingredient_id: String,
│     ingredient_name: String,
│     category_id: String,
│     amount: Number? (nullable),
│     unit: String? (nullable: "tablespoon" | "teaspoon" | "ml" | "gram"),
│     reaction: String? (nullable: "good" | "normal" | "bad"),
│     has_allergy: Boolean? (nullable: アレルギー反応の有無),
│     memo: String? (nullable: 食材ごとのメモ、最大100文字)
│   },
│   ...
│ ]
├── created_at: Timestamp
└── updated_at: Timestamp
```

### 5.2 カスタム食材

```
households/{householdId}/custom_ingredients/{ingredientId}
├── name: String
├── category_id: String
└── created_at: Timestamp
```

---

## 6. ユースケース

### 6.1 離乳食を新規記録する

1. 授乳表の「離乳食」行の空きマスをタップ
2. 食材選択画面が表示される
3. 食材カテゴリをタップしてプルダウンを展開
4. 食べた食材にチェックを入れる（複数選択可）
5. 必要に応じて他のカテゴリも展開して選択
6. 「次へ」ボタンをタップ
7. 量の記録画面に遷移
8. 各食材の量と単位を入力（任意）
9. 「保存」ボタンをタップ
10. 記録が保存され、授乳表に反映される

### 6.2 離乳食記録を編集する

1. 授乳表の記録済みマスをタップ
2. 既存の記録が読み込まれた状態で食材選択画面が表示
3. 食材の追加・削除を行う
4. 「次へ」ボタンをタップ
5. 量の編集を行う
6. 「保存」ボタンをタップ

### 6.3 カスタム食材を追加する

1. ベビーの記録画面の「離乳食」タブを開く
2. カテゴリのサブタブを選択
3. リスト最下部の「＋ 食材を追加」をタップ
4. ダイアログで食材名を入力
5. 「追加」をタップ
6. カスタム食材が「追加した食材」セクションに表示される

### 6.4 カスタム食材を編集する

1. ベビーの記録画面の「離乳食」タブを開く
2. 「追加した食材」セクションの編集したい食材の3点リーダー（⋮）をタップ
3. 「編集」を選択
4. ダイアログで食材名を修正
5. 「保存」をタップ
6. 食材名が更新される

### 6.5 カスタム食材を削除する

1. ベビーの記録画面の「離乳食」タブを開く
2. 「追加した食材」セクションの削除したい食材の3点リーダー（⋮）をタップ
3. 「削除」を選択
4. 確認ダイアログで「削除」をタップ
5. カスタム食材が削除される（過去の記録からは削除されない）

### 6.6 離乳食記録を削除する

1. 記録済みマスをタップ
2. 編集画面で「削除」ボタンをタップ
3. 確認ダイアログで「削除」を選択
4. 記録が削除される

---

## 7. バリデーション

| 項目 | ルール |
|------|--------|
| 食材選択 | 1つ以上の食材が選択されていること |
| 量 | 入力する場合は0以上の数値 |
| カスタム食材名 | 1文字以上、空白のみは不可 |
| 記録時刻 | 未来の日時は不可（当日まで） |

---

## 8. 表示仕様

### 8.1 授乳表での表示

- 「離乳食」列を「搾母乳」列の右側に追加（列順: 授乳, ミルク, 搾母乳, **離乳食**, 尿, 便, 体温, その他）
- 離乳食が記録されているマスには ● を表示
- 合計行には離乳食の記録回数を「◯回」形式で表示
- タップすると詳細を確認・編集可能

### 8.2 記録サマリー表示

離乳食マスをタップした際の詳細表示（編集画面）または、ロングタップでのプレビュー：

```
12:00 離乳食
──────────────
米 5大さじ
にんじん 2小さじ
豆腐 30g
うどん（量なし）
```

### 8.3 離乳食タブでの表示

- ベビーの記録画面のタブ順: **授乳表 / 離乳食 / 成長曲線**
- 離乳食タブは食材カテゴリごとのサブタブを表示
- 各食材行に「食べた/未」「反応（good/normal/bad）」を表示
- 反応アイコンは子供のアイコンに対応（例: bear_good / bear_normal / bear_bad）
- 表示データは `baby_food_records` の集計結果を使用（案A）

---

## 9. 今後の拡張案（スコープ外）

以下は本設計のスコープ外だが、将来的な拡張として検討可能：

- **初回食材マーキング**: 初めて食べた食材の自動マーキング、初回食材一覧表示
- **離乳食ステージ管理**: 初期・中期・後期・完了期の自動判定
- **レシピ機能**: 複数食材を組み合わせた料理の登録
- **食材履歴**: 食材ごとの摂取履歴グラフ
- **栄養バランス表示**: カテゴリごとの摂取バランスの可視化

---

## 10. 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-12-27 | 1.0 | 初版作成 |
| 2025-12-28 | 1.1 | 記録画面からのカスタム食材追加機能を削除。メニュー画面からの追加に変更。UIをアコーディオン形式に変更、ヘルプリンクを追加。 |
| 2025-12-28 | 1.2 | 食材管理画面（2.5節）を追加。メニューから食材の追加・削除ができる機能を実装。 |
| 2025-12-28 | 1.3 | デフォルト食材の削除・復元機能を追加。非表示食材のFirestore構造（5.3節）を追加。 |
| 2025-12-28 | 1.4 | 量の記録画面のレイアウトを複数行構成に変更（食材名/量/反応+アレルギー/メモの4行）。BabyFoodItemにhasAllergy（アレルギー有無）とmemo（メモ）フィールドを追加。 |
| 2025-12-28 | 1.5 | メニュー画面の「離乳食の食材管理」を廃止。離乳食タブに食材追加機能を移動。カスタム食材に3点リーダーメニュー（編集・削除）を追加。デフォルト食材の非表示機能を廃止。 |
