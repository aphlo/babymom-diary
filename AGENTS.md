# Babymom Diary コーディング規約

## アーキテクチャの基本方針
- 各機能は MVVM とドメイン駆動設計（DDD）を組み合わせて構成
- プレゼンテーション層（Widget、アニメーション、ナビゲーション）はドメイン層のアダプタとして振る舞い、UI 更新以外の副作用を持たないようにする。
- 分析・ログなどの横断的関心事は明確なインターフェースを介して扱い、インフラの詳細をドメイン層へ漏らさない。

## MVVM の運用（CalendarPage / AddCalendarEventPage）
- **View（Widget/Page）**: `ViewModel` が公開する状態を宣言的に描画し、ユーザー操作をコールバックで渡す。View 層からリポジトリやデータソースを直接参照しない。
- **ViewModel（状態管理）**: 機能固有の状態とユースケース呼び出しを担当し、イミュータブルな値やストリームを View に公開する。`CalendarEventModel` のようなプレゼンテーション向けモデルや入力バリデーションのみを含め、`BuildContext` への依存を避ける。
- **Model / Mapper**: ドメインエンティティと UI モデルの変換を担当。Mapper はプレゼンテーション層に配置し、ドメイン層を Flutter 非依存に保つ。
- 新しい画面や UI 責務を追加する際は `lib/src/features/calendar/presentation` の構造に倣い、可能であれば ViewModel を Flutter 依存なくテストできるユニット／ウィジェットテストを用意する。

## ドメイン駆動設計（DDD）
- **エンティティ / 値オブジェクト**: `CalendarEvent` などのコア概念は `lib/src/features/.../domain/entities` に immutable な型として定義し、不変条件を型内で担保する。生成時に必ず正しい状態を満たすよう、コンストラクタやファクトリで検証する。
- **ユースケース / アプリケーションサービス**: `AddCalendarEvent` などの機能操作は `application/usecases` に実装し、リポジトリやドメインサービスを調停する。UI モデルではなくドメインオブジェクトや結果型を返す。
- **リポジトリ**: インターフェースを `domain/repositories` に定義し、Firestore などの実装は `infrastructure/repositories` に配置する。インフラ固有の DTO や Mapper はインフラ層に閉じ込める。
- **データソース**: `.../infrastructure/sources` で外部システムへのアクセスをカプセル化し、ドメイン層へ渡る前にドメイン寄りの表現へ変換する。
- ドメイン層は Flutter・Firebase・プラットフォームパッケージに依存しない。依存性逆転によりテストや将来の差し替えに備える。

## 開発プロセスの期待値
- 新機能を追加する際は、まずドメインエンティティやユースケースを設計・拡張し、リポジトリ経由で公開してから ViewModel と View を実装する。
- プレゼンテーション層とドメイン層の責務を揃える。ViewModel の新しい動作はユースケースへ委譲し、ViewModel 内にドメインロジックを閉じ込めない。
- MVVM や DDD から外れる実装を導入する場合は、理由と影響をこのファイルに追記し、将来の開発者が判断を共有できるようにする。
